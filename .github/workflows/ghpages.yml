name: Publish Documentation

on:
  push:
    branches:
    - master
    - docpush

jobs:
  build:

    runs-on: windows-latest

    steps:
        
    - name: Clone NmeaParser
      uses: actions/checkout@v1

    - name: Download DocFX
      run: |
        mkdir .tools/docfx
        Invoke-WebRequest -Uri "https://github.com/dotnet/docfx/releases/download/v${env:DOCFXVERSION}/docfx.zip" -OutFile ".tools/docfx/docfx.zip"
        [System.IO.Compression.ZipFile]::ExtractToDirectory(".tools/docfx/docfx.zip", ".tools/docfx" )
      env:
        DOCFXVERSION: 2.48.1

    - name: Install .NET OMD Generator
      run: dotnet tool install --tool-path .tools/omd dotMorten.OmdGenerator --version 1.2.0

    - name: Generate OMD
      run: |
        mkdir artifacts/docs/api
        .tools/omd/generateomd /source=src/NmeaParser /output=artifacts/docs/api/omd.html
        
    - name: Build Documentation
      run: .tools/docfx/docfx.exe docs/docfx.json
      
    - name: Publish Documentation
      env:
        ACCESS_TOKEN: ${{ secrets.GH_PAT }}
        BRANCH: gh-pages
        DOCSFOLDER: artifacts/docs_site
      run: |
        git worktree add --checkout gh-action-temp-deployment-folder origin/${env:BRANCH}
        Remove-Item -Path gh-action-temp-deployment-folder\* -Recurse -Exclude .git
        xcopy artifacts\docs_site\*.* gh-action-temp-deployment-folder /S
        echo *********** copy complete
        cd .\gh-action-temp-deployment-folder\
        git add .
        echo *********** stage complete
        git commit -m "Auto-update doc from commit ${env:GITHUB_SHA}"
        echo *********** commit complete
        git push 
        echo *********** push complete        
# REPO: https://github.com/%GITHUB_REPOSITORY%, SHA: %GITHUB_SHA% Branch: %BRANCH%

#    - name: Publish Documentation
#      uses: maxheld83/ghpages@master
#      env:
#        BUILD_DIR: artifacts/docs_site
#        GH_PAT: ${{ secrets.GH_PAT }}
#      uses: JamesIves/github-pages-deploy-action@releases/v3
#      with:
#        ACCESS_TOKEN: ${{ secrets.GH_PAT }}
#        BRANCH: gh-pages # The branch the action should deploy to.
#        FOLDER: artifacts/docs_site # The folder the action should deploy.
